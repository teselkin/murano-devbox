#cloud-config
packages:
 - git

users:
  - default
  - name: murano
    gecos: Murano User
    inactive: true
    system: true

write_files:
 - path: /home/murano/devbox.sh
   owner:
   permissions: '0644'
   content: |
    #!/bin/bash
    export RABBIT_HOST=127.0.0.1
    export RABBIT_PASSWORD=
    export KEYSTONE_AUTH_HOST=172.16.40.137
    export KEYSTONE_AUTH_PORT=5000
    export KEYSTONE_AUTH_PROTOCOL=http
    export KEYSTONE_SSL_CA=
    export SERVICE_TENANT_NAME=murano
    export MURANO_ADMIN_USER=velovec
    export SERVICE_PASSWORD=19v9m24u~
    export MYSQL_ROOT_PASSWORD=qwerty
    export MYSQL_MURANO_PASSWORD=qwerty
    export MURANO_REPO=https://github.com/stackforge/murano
    export MURANO_DASHBOARD_REPO=https://github.com/stackforge/murano-dashboard
    export MURANO_APPS_REPO=https://github.com/murano-project/murano-app-incubator
    export MURANO_BRANCH=master
    export MURANO_DASHBOARD_BRANCH=master
    export MURANO_APP_BRANCH=master

    case $1 in
     install)
      /home/murano/murano-devbox/manage-devbox.sh install
      /home/murano/murano-devbox/manage-devbox.sh configure
      /home/murano/murano-devbox/manage-devbox.sh start
     ;;
     configure)
      /home/murano/murano-devbox/manage-devbox.sh configure
      /home/murano/murano-devbox/manage-devbox.sh restart
     ;;
     restart)
      /home/murano/murano-devbox/manage-devbox.sh restart
     esac

bootcmd:
 - [ cloud-init-per, once, sed -i, 's/#PermitRootLogin yes/PermitRootLogin no/g', /etc/ssh/sshd_config ]
 - [ cloud-init-per, once, service, ssh, restart ]
 - [ cloud-init-per, once, sudo, -i, -u, murano, git, clone, http://git.linachan.ru/mirantis-inc/murano-devbox.git ]
 - [ cloud-init-per, once, sudo, -i, -u, murano, /home/murano/devbox.sh, install ]
